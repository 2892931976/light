// DO NOT EDIT THIS FILE !
// It is generated by persis tool, source from demo.go.
package persist

import (
	"bytes"
	"encoding/json"
	"github.com/gotips/log"
	"database/sql"
	"github.com/arstd/persist/examples/domain"
)

var _ = json.Marshal

type DemoPersist struct{}

func (*DemoPersist) List(tx *sql.Tx, d *domain.Demo, statuses []domain.Status, page int, size int) ( []*domain.Demo,  error) {

	query, args := bytes.NewBuffer([]byte{}), []interface{}{}


		query.WriteString("select id, name, third_field, status, content from demos where name=$1 ")
		args = append(args, d.Name)

	if d.ThirdField != false {
		query.WriteString("and third_field=$2 ")
		args = append(args, d.ThirdField)
	}

	if d.Content != nil {
		query.WriteString("and content=$3 ")
		d_Content, err := json.Marshal(d.Content)
		if err != nil {
			log.Errorf("marshal(%#v) error: %s",d.Content, err)
		}
		args = append(args, d_Content)
	}


	log.Debug(query.String())
	log.Debug(args...)
	rows, err := db.Query(query.String(), args...)
	if err != nil {
		log.Errorf("query(%s, %#v) error: %s", query, args, err)
		return nil, err
	}
	defer rows.Close()

    var xs []*domain.Demo
	for rows.Next() {
		var x domain.Demo
		xs = append(xs, &x)

		var x_Content []byte
        dest := []interface{}{ &x.Id, &x.Name, &x.ThirdField, &x.Status, &x_Content }

		err = rows.Scan(dest...)
		if err != nil {
			log.Errorf("scan rows for query(%s, %#v) error: %s", query, args, err)
			return nil, err
		}

	  
	  	x.Content = new(domain.Demo)
		err = json.Unmarshal(x_Content, x.Content)
		if err != nil {
		  log.Errorf("unmarshal(%s) error: %s",x_Content, err)
		}
	  

	}
	if err = rows.Err(); err != nil {
		log.Errorf("scan rows for query(%s, %#v) last error: %s", query, args, err)
		return nil, err
	}
	return xs, nil
}
